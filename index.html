<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Musical Archive</title>
  <link rel="icon" href="./icon.png">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#ffffff">

  <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --google-blue: #1a73e8;
      --google-red: #ea4335;
      --google-text: #3c4043;
      --modal-bg: #ffffff;
    }
    body { margin: 0; padding: 0; font-family: 'Roboto', sans-serif; color: var(--google-text); background-color: #fff; overflow: hidden; }
    #calendar { max-width: 100%; height: 100vh; margin: 0 auto; }
    
    /* ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ */
    .fc-header-toolbar { padding: 8px 16px !important; margin-bottom: 0 !important; background: #fff; position: sticky; top: 0; z-index: 1000; border-bottom: 1px solid #dadce0; }
    .fc-toolbar-title { font-size: 1.2em !important; font-weight: 500; }
    
    /* ã‚¤ãƒ™ãƒ³ãƒˆ */
    .fc-event { border: none !important; margin: 1px 2px !important; box-shadow: 0 1px 2px rgba(60,64,67,0.3); cursor: pointer; }
    .fc-event-main { color: #fff !important; padding: 2px 6px !important; font-size: 11px; font-weight: 500; border-radius: 4px; }
    .fc-day-today .fc-daygrid-day-number { background-color: var(--google-blue); color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; }

    /* --- å³ä¸‹ã®ï¼‹ãƒœã‚¿ãƒ³ (FAB) --- */
    .fab-btn {
      position: fixed;
      bottom: 24px;
      right: 24px;
      width: 56px;
      height: 56px;
      background-color: #fff;
      border-radius: 50%;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      color: var(--google-blue); /* Googleã‚«ãƒ©ãƒ¼ã®ãƒ—ãƒ©ã‚¹ */
      cursor: pointer;
      z-index: 1500;
      user-select: none;
      transition: transform 0.2s;
    }
    .fab-btn:active { transform: scale(0.95); background-color: #f1f3f4; }
    /* Googleã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³é¢¨ã®4è‰²ãƒ—ãƒ©ã‚¹è¨˜å·ã‚’ä½œã‚‹ã®ã¯è¤‡é›‘ãªã®ã§ã€ã‚·ãƒ³ãƒ—ãƒ«ã«é’è‰²ã§å®Ÿè£… */

    /* --- ãƒœãƒˆãƒ ã‚·ãƒ¼ãƒˆå…±é€š --- */
    .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); opacity: 0; visibility: hidden; transition: opacity 0.3s; z-index: 2000; }
    .overlay.active { opacity: 1; visibility: visible; }
    .bottom-sheet { position: fixed; bottom: -100%; left: 0; width: 100%; background: var(--modal-bg); border-top-left-radius: 16px; border-top-right-radius: 16px; box-shadow: 0 -2px 10px rgba(0,0,0,0.2); transition: bottom 0.3s cubic-bezier(0.16, 1, 0.3, 1); z-index: 2001; max-height: 85vh; display: flex; flex-direction: column; }
    .bottom-sheet.active { bottom: 0; }
    .sheet-header { padding: 12px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; }
    .sheet-handle { width: 40px; height: 4px; background-color: #ddd; border-radius: 2px; position: absolute; left: 50%; transform: translateX(-50%); top: 8px;}
    .close-btn { background: none; border: none; font-size: 24px; color: #5f6368; cursor: pointer; padding: 0 16px;}
    .save-btn { background: var(--google-blue); color: white; border: none; padding: 6px 16px; border-radius: 4px; font-weight: bold; cursor: pointer; margin-right: 8px;}
    .sheet-content { padding: 20px; overflow-y: auto; padding-bottom: 40px;}

    /* å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .input-group { margin-bottom: 16px; }
    .input-group label { display: block; font-size: 12px; color: #5f6368; margin-bottom: 4px; }
    .input-field { width: 100%; padding: 8px 0; border: none; border-bottom: 1px solid #ddd; font-size: 16px; outline: none; box-sizing: border-box; }
    .input-field:focus { border-bottom: 2px solid var(--google-blue); }
    textarea.input-field { resize: none; height: 60px; border: 1px solid #ddd; border-radius: 4px; padding: 8px; margin-top: 4px;}

    /* è‰²é¸æŠ */
    .color-options { display: flex; gap: 12px; margin-top: 8px; }
    .color-radio { display: none; }
    .color-circle { width: 32px; height: 32px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; position: relative;}
    .color-radio:checked + .color-circle { border-color: #5f6368; transform: scale(1.1); }
    /* ãƒã‚§ãƒƒã‚¯ãƒãƒ¼ã‚¯ */
    .color-radio:checked + .color-circle::after { content: 'âœ“'; color: white; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 14px; }

  </style>
</head>
<body>

  <div id='calendar'></div>

  <div class="fab-btn" id="fabBtn">ï¼‹</div>

  <div class="overlay" id="overlay"></div>

  <div class="bottom-sheet" id="detailSheet">
    <div class="sheet-header">
      <div class="sheet-handle"></div>
      <div style="flex:1"></div> <button class="close-btn" onclick="closeAllSheets()">Ã—</button>
    </div>
    <div class="sheet-content">
      <div style="font-size:0.9em; color:#5f6368; margin-bottom:8px;" id="detailDate"></div>
      <div style="font-size:1.4em; font-weight:bold; margin-bottom:16px;" id="detailTitle"></div>
      <div style="margin-bottom:16px;" id="detailMemo"></div>
      <div style="margin-bottom:16px; color:#5f6368;" id="detailLocation"></div>
      <a href="#" target="_blank" style="display:inline-block; background:var(--google-blue); color:white; text-decoration:none; padding:10px 20px; border-radius:24px;" id="detailLink">YouTubeã§è¦‹ã‚‹</a>
    </div>
  </div>

  <div class="bottom-sheet" id="addSheet">
    <div class="sheet-header">
      <button class="close-btn" onclick="closeAllSheets()">Ã—</button>
      <div style="font-weight:bold;">äºˆå®šã‚’è¿½åŠ </div>
      <button class="save-btn" id="saveBtn">ä¿å­˜</button>
    </div>
    <div class="sheet-content">
      <div class="input-group">
        <input type="text" id="inputTitle" class="input-field" placeholder="ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›" required>
      </div>

      <div class="input-group">
        <label>è‰²ã‚’é¸æŠ</label>
        <div class="color-options">
          <label><input type="radio" name="color" value="#ea4335" class="color-radio" checked><div class="color-circle" style="background:#ea4335;"></div></label> <label><input type="radio" name="color" value="#7986cb" class="color-radio"><div class="color-circle" style="background:#7986cb;"></div></label> <label><input type="radio" name="color" value="#33b679" class="color-radio"><div class="color-circle" style="background:#33b679;"></div></label> <label><input type="radio" name="color" value="#f4511e" class="color-radio"><div class="color-circle" style="background:#f4511e;"></div></label> <label><input type="radio" name="color" value="#039be5" class="color-radio"><div class="color-circle" style="background:#039be5;"></div></label> </div>
      </div>

      <div class="input-group" style="display:flex; gap:10px;">
        <div style="flex:1;">
          <label>é–‹å§‹æ—¥æ™‚</label>
          <input type="datetime-local" id="inputStart" class="input-field">
        </div>
        <div style="flex:1;">
          <label>çµ‚äº†æ—¥æ™‚</label>
          <input type="datetime-local" id="inputEnd" class="input-field">
        </div>
      </div>

      <div class="input-group">
        <label>å ´æ‰€</label>
        <input type="text" id="inputLocation" class="input-field" placeholder="å ´æ‰€ã‚’è¿½åŠ ">
      </div>

      <div class="input-group">
        <label>ãƒ¡ãƒ¢</label>
        <textarea id="inputMemo" class="input-field" placeholder="ãƒ¡ãƒ¢ã‚’è¿½åŠ "></textarea>
      </div>
    </div>
  </div>

  <script>
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbxt5yqGKDgCmALZ7OROxOR4-XaDz2YCLRnlDTWFKxAMcu1BBafZEQVPAKBZBEqmdKrgBw/exec';

    const overlay = document.getElementById('overlay');
    const detailSheet = document.getElementById('detailSheet');
    const addSheet = document.getElementById('addSheet');
    
    // ã‚·ãƒ¼ãƒˆã‚’é–‰ã˜ã‚‹
    function closeAllSheets() {
      overlay.classList.remove('active');
      detailSheet.classList.remove('active');
      addSheet.classList.remove('active');
    }
    overlay.addEventListener('click', closeAllSheets);

    // è©³ç´°è¡¨ç¤ºã‚’é–‹ã
    function openDetail(event) {
      const dateStr = event.start.toLocaleDateString('ja-JP', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute:'2-digit' });
      document.getElementById('detailDate').textContent = dateStr;
      document.getElementById('detailTitle').textContent = event.title;
      
      const memo = event.extendedProps.memo || '';
      const location = event.extendedProps.location || '';
      
      document.getElementById('detailMemo').textContent = memo;
      document.getElementById('detailLocation').textContent = location ? 'ğŸ“ ' + location : '';
      
      const linkBtn = document.getElementById('detailLink');
      if (event.url) {
        linkBtn.href = event.url;
        linkBtn.style.display = 'inline-block';
        linkBtn.textContent = 'YouTubeã§è¦‹ã‚‹';
      } else {
        linkBtn.style.display = 'none';
      }

      overlay.classList.add('active');
      detailSheet.classList.add('active');
    }

    // è¿½åŠ ç”»é¢ã‚’é–‹ã
    function openAddForm(dateStr = '') {
      // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
      document.getElementById('inputTitle').value = '';
      document.getElementById('inputLocation').value = '';
      document.getElementById('inputMemo').value = '';
      
      // æ—¥æ™‚ã®åˆæœŸå€¤è¨­å®š
      const now = new Date();
      if(dateStr) {
        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®æ—¥ä»˜ã‚¿ãƒƒãƒ—æ™‚
        document.getElementById('inputStart').value = dateStr + 'T09:00';
        document.getElementById('inputEnd').value = dateStr + 'T10:00';
      } else {
        // ï¼‹ãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚ï¼ˆç¾åœ¨æ™‚åˆ»ï¼‰
        const isoNow = new Date(now.getTime() - (now.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
        document.getElementById('inputStart').value = isoNow;
        document.getElementById('inputEnd').value = isoNow;
      }
      
      overlay.classList.add('active');
      addSheet.classList.add('active');
      document.getElementById('inputTitle').focus();
    }

    // ä¿å­˜å‡¦ç†
    function saveEvent() {
      const title = document.getElementById('inputTitle').value;
      if(!title) { alert('ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }

      const start = document.getElementById('inputStart').value;
      const end = document.getElementById('inputEnd').value;
      const location = document.getElementById('inputLocation').value;
      const memo = document.getElementById('inputMemo').value;
      const color = document.querySelector('input[name="color"]:checked').value;

      const postData = {
        title: title,
        start: start,
        end: end,
        location: location,
        memo: memo,
        color: color
      };

      // ãƒœã‚¿ãƒ³ã‚’ä¿å­˜ä¸­ã«ã™ã‚‹
      const saveBtn = document.getElementById('saveBtn');
      saveBtn.textContent = 'ä¿å­˜ä¸­...';
      saveBtn.disabled = true;

      // GASã«é€ä¿¡
      fetch(GAS_URL, {
        method: 'POST',
        body: JSON.stringify(postData)
      })
      .then(response => response.json())
      .then(data => {
        alert('ä¿å­˜ã—ã¾ã—ãŸï¼');
        closeAllSheets();
        location.reload(); // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å†èª­ã¿è¾¼ã¿ï¼ˆæ‰‹æŠœãã ãŒç¢ºå®Ÿï¼‰
      })
      .catch(error => {
        console.error('Error:', error);
        alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
        saveBtn.textContent = 'ä¿å­˜';
        saveBtn.disabled = false;
      });
    }

    // Ctrl+S ã§ä¿å­˜
    document.addEventListener('keydown', function(e) {
      if ((e.ctrlKey || e.metaKey) && e.key === 's') {
        e.preventDefault();
        if (addSheet.classList.contains('active')) {
          saveEvent();
        }
      }
    });

    document.getElementById('saveBtn').addEventListener('click', saveEvent);
    document.getElementById('fabBtn').addEventListener('click', () => openAddForm());

    document.addEventListener('DOMContentLoaded', function() {
      var calendarEl = document.getElementById('calendar');
      var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'multiMonthYear',
        multiMonthMaxColumns: 1,
        locale: 'ja',
        
        customButtons: {
          myPrev: { text: 'â€¹', click: function() { calendar.incrementDate({ months: -1 }); }},
          myNext: { text: 'â€º', click: function() { calendar.incrementDate({ months: 1 }); }}
        },
        headerToolbar: { left: 'myPrev,myNext today', center: 'title', right: '' },
        eventDisplay: 'block',
        dayMaxEvents: true,

        // æ—¥ä»˜ã‚¿ãƒƒãƒ—ã§è¿½åŠ ç”»é¢ã¸
        dateClick: function(info) {
          openAddForm(info.dateStr);
        },

        events: function(info, successCallback, failureCallback) {
          fetch(GAS_URL)
            .then(response => response.json())
            .then(data => successCallback(data))
            .catch(error => failureCallback(error));
        },

        eventClick: function(info) {
          info.jsEvent.preventDefault();
          openDetail(info.event);
        }
      });
      calendar.render();
    });

    if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js?v=5');
  </script>
</body>
</html>
