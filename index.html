<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Musical Archive</title>
  <link rel="icon" href="./icon.png">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#ffffff">

  <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    :root { --google-blue: #1a73e8; --text-color: #3c4043; --border-color: #dadce0; }
    body { margin: 0; padding: 0; font-family: 'Roboto', sans-serif; color: var(--text-color); background: #fff; height: 100vh; display: flex; overflow: hidden; }

    /* --- レイアウト: サイドバーとメイン --- */
    .sidebar {
      width: 250px;
      background: #f8f9fa;
      border-right: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      padding: 16px;
      overflow-y: auto;
      flex-shrink: 0; /* 縮まないようにする */
    }
    .main-content {
      flex: 1;
      position: relative;
      overflow: hidden;
    }
    
    @media (max-width: 768px) {
      .sidebar { display: none; } /* スマホではサイドバー非表示（本来はハンバーガーメニュー推奨） */
    }

    /* バンド一覧 */
    .band-list-header { font-weight: bold; margin-bottom: 12px; font-size: 1.1em; }
    .band-item {
      display: flex;
      align-items: center;
      padding: 8px;
      margin-bottom: 4px;
      border-radius: 4px;
      cursor: default;
      position: relative;
    }
    .band-item:hover { background: #e8f0fe; }
    .band-color-dot {
      width: 16px; height: 16px; border-radius: 50%; margin-right: 10px;
      border: 1px solid rgba(0,0,0,0.1);
    }
    .band-name { font-size: 0.95em; flex: 1; }
    
    /* ホバー時のメンバー表示ツールチップ */
    .band-item:hover::after {
      content: attr(data-members);
      position: absolute;
      left: 100%;
      top: 0;
      background: #333;
      color: #fff;
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 12px;
      white-space: nowrap;
      z-index: 3000;
      pointer-events: none;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    .btn-add-band {
      margin-top: 12px;
      background: transparent;
      border: 1px dashed var(--border-color);
      color: var(--google-blue);
      padding: 8px;
      border-radius: 4px;
      cursor: pointer;
      text-align: center;
      font-size: 0.9em;
    }
    .btn-add-band:hover { background: #f1f3f4; }

    /* カレンダー本体 */
    #calendar { height: 100vh; }
    
    /* 共通UI */
    .fab-btn { position: fixed; bottom: 24px; right: 24px; width: 56px; height: 56px; background: #fff; border-radius: 50%; box-shadow: 0 4px 10px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; font-size: 32px; color: var(--google-blue); cursor: pointer; z-index: 1500; transition: transform 0.2s; }
    .fab-btn:active { transform: scale(0.95); }

    .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); opacity: 0; visibility: hidden; transition: opacity 0.3s; z-index: 2000; }
    .overlay.active { opacity: 1; visibility: visible; }
    
    .bottom-sheet { position: fixed; bottom: -100%; left: 0; width: 100%; background: #fff; border-top-left-radius: 16px; border-top-right-radius: 16px; box-shadow: 0 -2px 10px rgba(0,0,0,0.2); transition: bottom 0.3s ease; z-index: 2001; max-height: 90vh; display: flex; flex-direction: column; }
    .bottom-sheet.active { bottom: 0; }
    .sheet-content { padding: 20px; overflow-y: auto; padding-bottom: 40px; }

    .input-group { margin-bottom: 16px; }
    .input-group label { display: block; font-size: 12px; color: #5f6368; margin-bottom: 4px; }
    .input-field { width: 100%; padding: 8px 0; border: none; border-bottom: 1px solid #ddd; font-size: 16px; outline: none; background: transparent; }
    .input-field:focus { border-bottom: 2px solid var(--google-blue); }

    /* 時間ショートカットボタン */
    .time-presets { display: flex; gap: 8px; margin-bottom: 8px; flex-wrap: wrap; }
    .preset-btn {
      padding: 4px 10px;
      font-size: 12px;
      border: 1px solid #ddd;
      border-radius: 16px;
      background: #f1f3f4;
      cursor: pointer;
      color: #3c4043;
    }
    .preset-btn:hover { background: #e8f0fe; border-color: var(--google-blue); color: var(--google-blue); }

    /* 色選択（バンドベース） */
    .color-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(40px, 1fr)); gap: 10px; margin-top: 8px; }
    .color-option { text-align: center; cursor: pointer; }
    .color-circle { width: 32px; height: 32px; border-radius: 50%; margin: 0 auto; position: relative; border: 2px solid transparent;}
    .color-radio { display: none; }
    .color-radio:checked + .color-circle { border-color: #5f6368; transform: scale(1.1); }
    .color-radio:checked + .color-circle::after { content: '✓'; color: white; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 14px; }
    .color-label { font-size: 10px; margin-top: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    /* その他ボタン */
    .close-btn { background: none; border: none; font-size: 24px; cursor: pointer; }
    .action-btn { border: none; padding: 8px 16px; border-radius: 4px; font-weight: bold; cursor: pointer; margin-left: 8px; font-size: 14px; }
    .btn-save { background: var(--google-blue); color: white; }
    .btn-delete { background: #fff; color: #d93025; border: 1px solid #dadce0; }
  </style>
</head>
<body>

  <div class="sidebar">
    <div class="band-list-header">バンド一覧</div>
    <div id="bandListContainer">
      </div>
    <button class="btn-add-band" onclick="openBandForm()">＋ バンドを追加</button>
  </div>

  <div class="main-content">
    <div id='calendar'></div>
    <div class="fab-btn" id="fabBtn">＋</div>
  </div>

  <div class="overlay" id="overlay"></div>

  <div class="bottom-sheet" id="bandSheet">
    <div class="sheet-content">
      <div style="display:flex; justify-content:space-between; margin-bottom:16px;">
        <button class="close-btn" onclick="closeAllSheets()">×</button>
        <span style="font-weight:bold; font-size:1.2em;">バンド追加</span>
        <button class="action-btn btn-save" id="saveBandBtn">保存</button>
      </div>
      <div class="input-group">
        <label>バンド名</label>
        <input type="text" id="bandName" class="input-field" placeholder="例: スピッツバンド">
      </div>
      <div class="input-group">
        <label>メンバー (カンマ区切り)</label>
        <input type="text" id="bandMembers" class="input-field" placeholder="例: 佐藤, 田中, 鈴木">
      </div>
      <div class="input-group">
        <label>イメージカラー</label>
        <input type="color" id="bandColor" value="#ea4335" style="width:100%; height:40px; border:none;">
      </div>
    </div>
  </div>

  <div class="bottom-sheet" id="eventSheet">
    <div class="sheet-content">
      <div style="display:flex; justify-content:space-between; margin-bottom:16px;">
        <button class="close-btn" onclick="closeAllSheets()">×</button>
        <span style="font-weight:bold; font-size:1.2em;" id="eventFormTitle">予定を追加</span>
        <div>
           <button class="action-btn btn-delete" id="deleteEventBtn" style="display:none;">削除</button>
           <button class="action-btn btn-save" id="saveEventBtn">保存</button>
        </div>
      </div>
      
      <input type="hidden" id="eventId">

      <div class="input-group">
        <input type="text" id="eventTitle" class="input-field" placeholder="タイトル" style="font-size:1.4em;">
      </div>

      <div class="input-group">
        <label>クイック時間選択</label>
        <div class="time-presets">
          <button class="preset-btn" onclick="applyPreset('16:45','18:00')">5限</button>
          <button class="preset-btn" onclick="applyPreset('18:00','19:00')">① 18-19</button>
          <button class="preset-btn" onclick="applyPreset('19:00','20:00')">② 19-20</button>
          <button class="preset-btn" onclick="applyPreset('20:00','21:00')">③ 20-21</button>
        </div>
      </div>

      <div class="input-group" style="display:flex; gap:10px;">
        <div style="flex:1;">
          <label>開始</label>
          <input type="date" id="startDate" class="input-field">
          <input type="time" id="startTime" class="input-field">
        </div>
        <div style="flex:1;">
          <label>終了</label>
          <input type="date" id="endDate" class="input-field">
          <input type="time" id="endTime" class="input-field">
        </div>
      </div>

      <div class="input-group">
        <label>場所</label>
        <input type="text" id="eventLocation" class="input-field" placeholder="スタジオA">
      </div>
      <div class="input-group">
        <label>メモ</label>
        <textarea id="eventMemo" class="input-field" style="height:60px;" placeholder="メモ"></textarea>
      </div>

      <div class="input-group">
        <label>バンド/色を選択</label>
        <div class="color-grid" id="colorContainer">
          </div>
      </div>
    </div>
  </div>

  <script>
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbxt5yqGKDgCmALZ7OROxOR4-XaDz2YCLRnlDTWFKxAMcu1BBafZEQVPAKBZBEqmdKrgBw/exec';
    
    // グローバル変数
    let allEvents = [];
    let allBands = [];
    let currentEvent = null;

    // --- ユーティリティ ---
    function closeAllSheets() {
      document.getElementById('overlay').classList.remove('active');
      document.getElementById('bandSheet').classList.remove('active');
      document.getElementById('eventSheet').classList.remove('active');
    }
    document.getElementById('overlay').addEventListener('click', closeAllSheets);

    // --- バンド関連処理 ---
    function renderBandList() {
      const container = document.getElementById('bandListContainer');
      const colorContainer = document.getElementById('colorContainer');
      
      container.innerHTML = '';
      colorContainer.innerHTML = '';

      // デフォルト色（その他用）
      const defaultColorHtml = `
        <label class="color-option">
          <input type="radio" name="eventColor" value="#ea4335" class="color-radio" checked>
          <div class="color-circle" style="background:#ea4335;"></div>
          <div class="color-label">その他</div>
        </label>`;
      colorContainer.innerHTML += defaultColorHtml;

      allBands.forEach(band => {
        // サイドバー一覧
        const div = document.createElement('div');
        div.className = 'band-item';
        div.dataset.members = band.members || 'メンバー未登録';
        div.innerHTML = `<div class="band-color-dot" style="background:${band.color}"></div><div class="band-name">${band.name}</div>`;
        container.appendChild(div);

        // 予定追加時の色選択肢
        const radioHtml = `
          <label class="color-option">
            <input type="radio" name="eventColor" value="${band.color}" class="color-radio">
            <div class="color-circle" style="background:${band.color};"></div>
            <div class="color-label">${band.name}</div>
          </label>`;
        colorContainer.innerHTML += radioHtml;
      });
    }

    function openBandForm() {
      closeAllSheets();
      document.getElementById('overlay').classList.add('active');
      document.getElementById('bandSheet').classList.add('active');
    }

    document.getElementById('saveBandBtn').addEventListener('click', () => {
      const name = document.getElementById('bandName').value;
      const members = document.getElementById('bandMembers').value;
      const color = document.getElementById('bandColor').value;
      if(!name) { alert('バンド名は必須です'); return; }

      sendToGAS({ target: 'band', action: 'create', name, members, color });
    });

    // --- 予定関連処理 ---
    
    // 時間プリセット適用
    window.applyPreset = function(startT, endT) {
      document.getElementById('startTime').value = startT;
      document.getElementById('endTime').value = endT;
      
      // 日付が空なら今日を入れる
      if(!document.getElementById('startDate').value) {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('startDate').value = today;
        document.getElementById('endDate').value = today;
      }
    };

    function openEventForm(isEdit = false, dateStr = null, eventObj = null) {
      closeAllSheets();
      
      // 1. フォームリセット
      document.getElementById('eventTitle').value = '';
      document.getElementById('eventLocation').value = '';
      document.getElementById('eventMemo').value = '';
      document.getElementById('deleteEventBtn').style.display = 'none';
      
      // デフォルト色の選択
      const radios = document.getElementsByName('eventColor');
      if(radios.length > 0) radios[0].checked = true;

      // 2. 編集モードの場合のデータ注入
      if (isEdit && eventObj) {
        
        if (eventObj.id && String(eventObj.id).startsWith('vid_')) {
             document.getElementById('eventFormTitle').textContent = '動画の詳細';
             document.getElementById('deleteEventBtn').style.display = 'none'; // 削除ボタンを隠す
             document.getElementById('saveEventBtn').style.display = 'none';   // 保存ボタンを隠す
        } else {
             document.getElementById('eventFormTitle').textContent = '予定を編集';
             document.getElementById('deleteEventBtn').style.display = 'inline-block'; // 削除ボタンを表示
             document.getElementById('saveEventBtn').style.display = 'inline-block';   // 保存ボタンを表示
        }
        
        document.getElementById('eventId').value = eventObj.id;
        document.getElementById('eventTitle').value = eventObj.title;
        document.getElementById('eventLocation').value = eventObj.extendedProps.location || '';
        document.getElementById('eventMemo').value = eventObj.extendedProps.memo || '';

        // 日時
        const s = eventObj.start;
        const e = eventObj.end || new Date(s.getTime() + 60*60*1000);
        document.getElementById('startDate').value = toDateStr(s);
        document.getElementById('startTime').value = toTimeStr(s);
        document.getElementById('endDate').value = toDateStr(e);
        document.getElementById('endTime').value = toTimeStr(e);

        // 色選択
        for(let r of radios) {
          if(r.value === eventObj.backgroundColor) r.checked = true;
        }

      } else {
        // 3. 新規モード
        document.getElementById('eventFormTitle').textContent = '予定を追加';
        document.getElementById('eventId').value = '';
        
        // 日時の初期値
        const baseDate = dateStr ? new Date(dateStr) : new Date();
        document.getElementById('startDate').value = toDateStr(baseDate);
        document.getElementById('startTime').value = '09:00'; // デフォルト時間
        document.getElementById('endDate').value = toDateStr(baseDate);
        document.getElementById('endTime').value = '10:00';
      }

      document.getElementById('overlay').classList.add('active');
      document.getElementById('eventSheet').classList.add('active');
    }

    // ユーティリティ: Date -> "YYYY-MM-DD"
    function toDateStr(d) {
      if(!d) return '';
      const year = d.getFullYear();
      const month = ('0' + (d.getMonth() + 1)).slice(-2);
      const day = ('0' + d.getDate()).slice(-2);
      return `${year}-${month}-${day}`;
    }
    // ユーティリティ: Date -> "HH:mm"
    function toTimeStr(d) {
      if(!d) return '00:00';
      const h = ('0' + d.getHours()).slice(-2);
      const m = ('0' + d.getMinutes()).slice(-2);
      return `${h}:${m}`;
    }

    // 保存
    document.getElementById('saveEventBtn').addEventListener('click', () => {
      const id = document.getElementById('eventId').value;
      const title = document.getElementById('eventTitle').value;
      if(!title) { alert('タイトルを入力してください'); return; }

      const sD = document.getElementById('startDate').value;
      const sT = document.getElementById('startTime').value;
      const eD = document.getElementById('endDate').value;
      const eT = document.getElementById('endTime').value;
      const color = document.querySelector('input[name="eventColor"]:checked')?.value || '#ea4335';

      const data = {
        target: 'event',
        action: id ? 'update' : 'create',
        id: id,
        title: title,
        start: `${sD} ${sT}`,
        end: `${eD} ${eT}`,
        location: document.getElementById('eventLocation').value,
        memo: document.getElementById('eventMemo').value,
        color: color
      };
      sendToGAS(data);
    });

    document.getElementById('deleteEventBtn').addEventListener('click', () => {
      if(!confirm('削除しますか？')) return;
      const id = document.getElementById('eventId').value;
      sendToGAS({ target: 'event', action: 'delete', id: id });
    });

    // --- 通信処理 ---
    function sendToGAS(data) {
      const btns = document.querySelectorAll('button');
      btns.forEach(b => b.disabled = true); // 連打防止

      fetch(GAS_URL, {
        method: 'POST',
        body: JSON.stringify(data)
      })
      .then(res => res.json())
      .then(() => location.reload())
      .catch(e => {
        alert('エラーが発生しました');
        console.error(e);
        btns.forEach(b => b.disabled = false);
      });
    }

    // --- 初期化 ---
    document.addEventListener('DOMContentLoaded', function() {
      // カレンダー設定
      var calendarEl = document.getElementById('calendar');
      var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'multiMonthYear',
        multiMonthMaxColumns: 1,
        locale: 'ja',
        headerToolbar: { left: 'prev,next today', center: 'title', right: '' },
        eventDisplay: 'block',
        
        dateClick: function(info) {
          openEventForm(false, info.dateStr);
        },
        eventClick: function(info) {
          info.jsEvent.preventDefault();
          openEventForm(true, null, info.event); // 編集モードで開く
        },
        events: function(info, success, failure) {
          fetch(GAS_URL)
            .then(r => r.json())
            .then(data => {
              allEvents = data.events;
              allBands = data.bands;
              
              renderBandList(); // バンド一覧更新
              success(allEvents); // カレンダー描画
            })
            .catch(e => failure(e));
        }
      });
      calendar.render();

      document.getElementById('fabBtn').addEventListener('click', () => openEventForm(false));
    });

    if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js?v=7');
  </script>
</body>
</html>

