<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Musical Archive</title>
  <link rel="icon" href="./icon.png">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#ffffff">

  <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    :root { --google-blue: #1a73e8; --google-red: #ea4335; --google-text: #3c4043; --modal-bg: #ffffff; }
    body { margin: 0; padding: 0; font-family: 'Roboto', sans-serif; color: var(--google-text); background-color: #fff; overflow: hidden; }
    #calendar { max-width: 100%; height: 100vh; margin: 0 auto; }
    
    .fc-header-toolbar { padding: 8px 16px !important; margin-bottom: 0 !important; background: #fff; position: sticky; top: 0; z-index: 1000; border-bottom: 1px solid #dadce0; }
    .fc-toolbar-title { font-size: 1.2em !important; font-weight: 500; }
    .fc-event { border: none !important; margin: 1px 2px !important; box-shadow: 0 1px 2px rgba(60,64,67,0.3); cursor: pointer; }
    .fc-event-main { color: #fff !important; padding: 2px 6px !important; font-size: 11px; font-weight: 500; border-radius: 4px; }
    .fc-day-today .fc-daygrid-day-number { background-color: var(--google-blue); color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; }

    /* FAB */
    .fab-btn { position: fixed; bottom: 24px; right: 24px; width: 56px; height: 56px; background-color: #fff; border-radius: 50%; box-shadow: 0 4px 10px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; font-size: 32px; color: var(--google-blue); cursor: pointer; z-index: 1500; transition: transform 0.2s; }
    .fab-btn:active { transform: scale(0.95); background-color: #f1f3f4; }

    /* „Éú„Éà„É†„Ç∑„Éº„Éà */
    .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); opacity: 0; visibility: hidden; transition: opacity 0.3s; z-index: 2000; }
    .overlay.active { opacity: 1; visibility: visible; }
    .bottom-sheet { position: fixed; bottom: -100%; left: 0; width: 100%; background: var(--modal-bg); border-top-left-radius: 16px; border-top-right-radius: 16px; box-shadow: 0 -2px 10px rgba(0,0,0,0.2); transition: bottom 0.3s cubic-bezier(0.16, 1, 0.3, 1); z-index: 2001; max-height: 85vh; display: flex; flex-direction: column; }
    .bottom-sheet.active { bottom: 0; }
    .sheet-header { padding: 12px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; }
    .sheet-content { padding: 20px; overflow-y: auto; padding-bottom: 40px;}

    /* „Éú„Çø„É≥È°û */
    .close-btn { background: none; border: none; font-size: 24px; color: #5f6368; cursor: pointer; padding: 0 16px;}
    .action-btn { border: none; padding: 8px 16px; border-radius: 4px; font-weight: bold; cursor: pointer; margin-left: 8px; font-size: 14px;}
    .btn-save { background: var(--google-blue); color: white; }
    .btn-edit { background: #fff; color: #5f6368; border: 1px solid #dadce0; }
    .btn-delete { background: #fff; color: #d93025; border: 1px solid #dadce0; }

    /* „Éï„Ç©„Éº„É† */
    .input-group { margin-bottom: 16px; }
    .input-group label { display: block; font-size: 12px; color: #5f6368; margin-bottom: 4px; }
    .input-field { width: 100%; padding: 8px 0; border: none; border-bottom: 1px solid #ddd; font-size: 16px; outline: none; box-sizing: border-box; background: transparent;}
    .input-field:focus { border-bottom: 2px solid var(--google-blue); }
    textarea.input-field { resize: none; height: 60px; border: 1px solid #ddd; border-radius: 4px; padding: 8px; margin-top: 4px;}
    
    /* Êó•‰ªò„ÉªÊôÇÈñìÈÅ∏ÊäûÁî® */
    .datetime-row { display: flex; gap: 10px; align-items: center; }
    .date-input { flex: 2; }
    .time-select { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #fff; font-size: 14px;}

    /* Ëâ≤ÈÅ∏Êäû */
    .color-options { display: flex; gap: 12px; margin-top: 8px; }
    .color-radio { display: none; }
    .color-circle { width: 32px; height: 32px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; position: relative;}
    .color-radio:checked + .color-circle { border-color: #5f6368; transform: scale(1.1); }
    .color-radio:checked + .color-circle::after { content: '‚úì'; color: white; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 14px; }
  </style>
</head>
<body>

  <div id='calendar'></div>
  <div class="fab-btn" id="fabBtn">Ôºã</div>
  <div class="overlay" id="overlay"></div>

  <div class="bottom-sheet" id="detailSheet">
    <div class="sheet-header">
      <button class="close-btn" onclick="closeAllSheets()">√ó</button>
      <div>
        <button class="action-btn btn-edit" id="btnEdit">Á∑®ÈõÜ</button>
        <button class="action-btn btn-delete" id="btnDelete">ÂâäÈô§</button>
      </div>
    </div>
    <div class="sheet-content">
      <div style="font-size:0.9em; color:#5f6368; margin-bottom:8px;" id="detailDate"></div>
      <div style="font-size:1.4em; font-weight:bold; margin-bottom:16px;" id="detailTitle"></div>
      <div style="margin-bottom:16px;" id="detailMemo"></div>
      <div style="margin-bottom:16px; color:#5f6368;" id="detailLocation"></div>
      <a href="#" target="_blank" style="display:none; background:var(--google-blue); color:white; text-decoration:none; padding:10px 20px; border-radius:24px;" id="detailLink">YouTube„ÅßË¶ã„Çã</a>
    </div>
  </div>

  <div class="bottom-sheet" id="addSheet">
    <div class="sheet-header">
      <button class="close-btn" onclick="closeAllSheets()">√ó</button>
      <div style="font-weight:bold;" id="formTitle">‰∫àÂÆö„ÇíËøΩÂä†</div>
      <button class="action-btn btn-save" id="saveBtn">‰øùÂ≠ò</button>
    </div>
    <div class="sheet-content">
      <input type="hidden" id="editEventId"> <div class="input-group">
        <input type="text" id="inputTitle" class="input-field" placeholder="„Çø„Ç§„Éà„É´„ÇíÂÖ•Âäõ" required>
      </div>

      <div class="input-group">
        <label>Ëâ≤„ÇíÈÅ∏Êäû</label>
        <div class="color-options">
          <label><input type="radio" name="color" value="#ea4335" class="color-radio" checked><div class="color-circle" style="background:#ea4335;"></div></label>
          <label><input type="radio" name="color" value="#7986cb" class="color-radio"><div class="color-circle" style="background:#7986cb;"></div></label>
          <label><input type="radio" name="color" value="#33b679" class="color-radio"><div class="color-circle" style="background:#33b679;"></div></label>
          <label><input type="radio" name="color" value="#f4511e" class="color-radio"><div class="color-circle" style="background:#f4511e;"></div></label>
          <label><input type="radio" name="color" value="#039be5" class="color-radio"><div class="color-circle" style="background:#039be5;"></div></label>
        </div>
      </div>

      <div class="input-group">
        <label>ÈñãÂßã</label>
        <div class="datetime-row">
          <input type="date" id="startDate" class="input-field date-input">
          <select id="startTime" class="time-select"></select>
        </div>
      </div>
      <div class="input-group">
        <label>ÁµÇ‰∫Ü</label>
        <div class="datetime-row">
          <input type="date" id="endDate" class="input-field date-input">
          <select id="endTime" class="time-select"></select>
        </div>
      </div>

      <div class="input-group">
        <label>Â†¥ÊâÄ</label>
        <input type="text" id="inputLocation" class="input-field" placeholder="Â†¥ÊâÄ„ÇíËøΩÂä†">
      </div>
      <div class="input-group">
        <label>„É°„É¢</label>
        <textarea id="inputMemo" class="input-field" placeholder="„É°„É¢„ÇíËøΩÂä†"></textarea>
      </div>
    </div>
  </div>

  <script>
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbxt5yqGKDgCmALZ7OROxOR4-XaDz2YCLRnlDTWFKxAMcu1BBafZEQVPAKBZBEqmdKrgBw/exec';

    const overlay = document.getElementById('overlay');
    const detailSheet = document.getElementById('detailSheet');
    const addSheet = document.getElementById('addSheet');
    let currentEvent = null; // ÁèæÂú®Ë°®Á§∫‰∏≠„ÅÆ„Ç§„Éô„É≥„ÉàÊÉÖÂ†±„Çí‰øùÊåÅ

    // 15ÂàÜÂàª„Åø„ÅÆÊôÇÈñì„ÇíÁîüÊàê„Åô„ÇãÈñ¢Êï∞
    function populateTimeSelects() {
      const times = [];
      for (let h = 0; h < 24; h++) {
        for (let m = 0; m < 60; m += 15) {
          const hh = h.toString().padStart(2, '0');
          const mm = m.toString().padStart(2, '0');
          times.push(`${hh}:${mm}`);
        }
      }
      const options = times.map(t => `<option value="${t}">${t}</option>`).join('');
      document.getElementById('startTime').innerHTML = options;
      document.getElementById('endTime').innerHTML = options;
    }
    populateTimeSelects(); // ÂàùÊúüÂåñÊôÇ„Å´ÂÆüË°å

    function closeAllSheets() {
      overlay.classList.remove('active');
      detailSheet.classList.remove('active');
      addSheet.classList.remove('active');
      currentEvent = null;
    }
    overlay.addEventListener('click', closeAllSheets);

    // Ë©≥Á¥∞Ë°®Á§∫
    function openDetail(event) {
      currentEvent = event; // Á∑®ÈõÜ„ÉªÂâäÈô§Áî®„Å´‰øùÊåÅ
      
      const start = event.start;
      const end = event.end;
      const dateStr = start.toLocaleDateString('ja-JP', { month: 'long', day: 'numeric', weekday: 'short' });
      const timeStr = start.toLocaleTimeString('ja-JP', { hour: '2-digit', minute:'2-digit' }) + 
                      (end ? ' - ' + end.toLocaleTimeString('ja-JP', { hour: '2-digit', minute:'2-digit' }) : '');

      document.getElementById('detailDate').textContent = `${dateStr} ${timeStr}`;
      document.getElementById('detailTitle').textContent = event.title;
      document.getElementById('detailMemo').textContent = event.extendedProps.memo || '';
      document.getElementById('detailLocation').textContent = event.extendedProps.location ? 'üìç ' + event.extendedProps.location : '';

      const linkBtn = document.getElementById('detailLink');
      if (event.url) {
        linkBtn.href = event.url;
        linkBtn.style.display = 'inline-block';
      } else {
        linkBtn.style.display = 'none';
      }

      overlay.classList.add('active');
      detailSheet.classList.add('active');
    }

    // ËøΩÂä†„ÉªÁ∑®ÈõÜ„Éï„Ç©„Éº„É†„ÇíÈñã„Åè
    function openForm(isEdit = false, dateStr = null) {
      closeAllSheets(); // ‰∏ÄÊó¶Èñâ„Åò„Çã
      
      const titleLabel = document.getElementById('formTitle');
      const idInput = document.getElementById('editEventId');
      
      if (isEdit && currentEvent) {
        // Á∑®ÈõÜ„É¢„Éº„ÉâÔºöÊó¢Â≠ò„Éá„Éº„Çø„ÇíÂÖ•„Çå„Çã
        titleLabel.textContent = '‰∫àÂÆö„ÇíÁ∑®ÈõÜ';
        idInput.value = currentEvent.id;
        document.getElementById('inputTitle').value = currentEvent.title;
        document.getElementById('inputLocation').value = currentEvent.extendedProps.location || '';
        document.getElementById('inputMemo').value = currentEvent.extendedProps.memo || '';
        
        // Ëâ≤„ÇíÈÅ∏Êäû
        const color = currentEvent.backgroundColor;
        const radios = document.getElementsByName('color');
        radios.forEach(r => r.checked = (r.value === color));

        // Êó•ÊôÇ„ÇíÂàÜËß£„Åó„Å¶„Çª„ÉÉ„Éà
        const s = currentEvent.start;
        const e = currentEvent.end || new Date(s.getTime() + 60*60*1000); // ÁµÇ‰∫Ü„Å™„Åë„Çå„Å∞1ÊôÇÈñìÂæå
        
        document.getElementById('startDate').value = toDateInputValue(s);
        document.getElementById('startTime').value = toTimeInputValue(s);
        document.getElementById('endDate').value = toDateInputValue(e);
        document.getElementById('endTime').value = toTimeInputValue(e);

      } else {
        // Êñ∞Ë¶è‰ΩúÊàê„É¢„Éº„Éâ
        titleLabel.textContent = '‰∫àÂÆö„ÇíËøΩÂä†';
        idInput.value = ''; // Êñ∞Ë¶è„Éï„É©„Ç∞
        document.getElementById('inputTitle').value = '';
        document.getElementById('inputLocation').value = '';
        document.getElementById('inputMemo').value = '';
        
        // Êó•ÊôÇ„ÅÆÂàùÊúüÂÄ§
        const now = dateStr ? new Date(dateStr) : new Date();
        // ÊôÇÈñì„ÇíÁèæÂú®ÊôÇÂàª„Å´Ëøë„ÅÑ15ÂàÜÂàª„Åø„Å´‰∏∏„ÇÅ„Çã„Å™„Å©Ë™øÊï¥„Åó„Å¶„ÇÇËâØ„ÅÑ„Åå„ÄÅ„Åì„Åì„Åß„ÅØ„Ç∑„É≥„Éó„É´„Å´9:00Âõ∫ÂÆö„Å™„Å©„Åß
        if(dateStr) {
            document.getElementById('startDate').value = dateStr;
            document.getElementById('startTime').value = "09:00";
            document.getElementById('endDate').value = dateStr;
            document.getElementById('endTime').value = "10:00";
        } else {
            const today = toDateInputValue(new Date());
            document.getElementById('startDate').value = today;
            document.getElementById('startTime').value = "09:00";
            document.getElementById('endDate').value = today;
            document.getElementById('endTime').value = "10:00";
        }
      }

      overlay.classList.add('active');
      addSheet.classList.add('active');
    }

    // Êó•‰ªò„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Çí input type="date" Áî®„ÅÆÊñáÂ≠óÂàó(yyyy-mm-dd)„Å´Â§âÊèõ
    function toDateInputValue(date) {
      if (!date) return '';
      const year = date.getFullYear();
      const month = (date.getMonth() + 1).toString().padStart(2, '0');
      const day = date.getDate().toString().padStart(2, '0');
      return `${year}-${month}-${day}`;
    }
    // ÊôÇÈñì„ÇíHH:mmÂΩ¢Âºè„Å´
    function toTimeInputValue(date) {
        if (!date) return '09:00';
        const h = date.getHours().toString().padStart(2, '0');
        let m = date.getMinutes();
        // 15ÂàÜÂàª„Åø„Å´Âêà„Çè„Åõ„ÇãÔºàÁ∞°ÊòìÁöÑÔºâ
        m = Math.round(m / 15) * 15;
        if (m === 60) m = 0; // Áπ∞„Çä‰∏ä„Åå„Çä„ÅØÁúÅÁï•ÔºàÂé≥ÂØÜ„Å´„ÅØÊó•ÊôÇ„Åæ„Åü„Åé„ÅÆÂá¶ÁêÜ„ÅåÂøÖË¶Å„Å†„Åå‰ªäÂõû„ÅØÁ∞°ÊòìÁâàÔºâ
        return `${h}:${m.toString().padStart(2, '0')}`;
    }

    // ‰øùÂ≠òÂá¶ÁêÜÔºàËøΩÂä†„ÉªÊõ¥Êñ∞Ôºâ
    document.getElementById('saveBtn').addEventListener('click', function() {
      const id = document.getElementById('editEventId').value;
      const title = document.getElementById('inputTitle').value;
      if(!title) { alert('„Çø„Ç§„Éà„É´„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }

      const startDate = document.getElementById('startDate').value;
      const startTime = document.getElementById('startTime').value;
      const endDate = document.getElementById('endDate').value;
      const endTime = document.getElementById('endTime').value;

      const fullStart = `${startDate} ${startTime}`;
      const fullEnd = `${endDate} ${endTime}`;

      const postData = {
        action: id ? 'update' : 'create', // ID„Åå„ÅÇ„Çå„Å∞Êõ¥Êñ∞„ÄÅ„Å™„Åë„Çå„Å∞Êñ∞Ë¶è
        id: id,
        title: title,
        start: fullStart,
        end: fullEnd,
        location: document.getElementById('inputLocation').value,
        memo: document.getElementById('inputMemo').value,
        color: document.querySelector('input[name="color"]:checked').value
      };

      sendToGAS(postData);
    });

    // ÂâäÈô§Âá¶ÁêÜ
    document.getElementById('btnDelete').addEventListener('click', function() {
      if(!currentEvent || !confirm('Êú¨ÂΩì„Å´ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) return;
      
      sendToGAS({
        action: 'delete',
        id: currentEvent.id
      });
    });

    // Á∑®ÈõÜ„Éú„Çø„É≥
    document.getElementById('btnEdit').addEventListener('click', function() {
      openForm(true);
    });

    // GASÈÄÅ‰ø°ÂÖ±ÈÄöÈñ¢Êï∞
    function sendToGAS(data) {
      const btn = data.action === 'delete' ? document.getElementById('btnDelete') : document.getElementById('saveBtn');
      const originalText = btn.textContent;
      btn.textContent = 'Âá¶ÁêÜ‰∏≠...';
      btn.disabled = true;

      fetch(GAS_URL, {
        method: 'POST',
        body: JSON.stringify(data)
      })
      .then(res => res.json())
      .then(json => {
        // ‚òÖ„É™„É≠„Éº„Éâ„Åó„Å¶ÂèçÊò†„Åï„Åõ„Çã
        location.reload();
      })
      .catch(err => {
        alert('„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
        btn.textContent = originalText;
        btn.disabled = false;
      });
    }

    // „Ç´„É¨„É≥„ÉÄ„ÉºÂàùÊúüÂåñ
    document.addEventListener('DOMContentLoaded', function() {
      var calendarEl = document.getElementById('calendar');
      var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'multiMonthYear',
        multiMonthMaxColumns: 1,
        locale: 'ja',
        customButtons: {
          myPrev: { text: '‚Äπ', click: () => calendar.incrementDate({ months: -1 }) },
          myNext: { text: '‚Ä∫', click: () => calendar.incrementDate({ months: 1 }) }
        },
        headerToolbar: { left: 'myPrev,myNext today', center: 'title', right: '' },
        eventDisplay: 'block',
        dayMaxEvents: true,

        dateClick: function(info) {
          openForm(false, info.dateStr);
        },
        eventClick: function(info) {
          info.jsEvent.preventDefault();
          openDetail(info.event);
        },
        events: function(info, success, failure) {
          fetch(GAS_URL).then(r => r.json()).then(d => success(d)).catch(e => failure(e));
        }
      });
      calendar.render();
      
      document.getElementById('fabBtn').addEventListener('click', () => openForm(false));
    });

    if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js?v=6');
  </script>
</body>
</html>
